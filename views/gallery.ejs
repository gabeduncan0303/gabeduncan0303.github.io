<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>
    <%= username %>'s Gallery
  </title>
  <link rel="stylesheet" href="/styles.css">
</head>

<body>
  <div class="container">
    <h1>Gallery for <%= username %>
    </h1>
    <p><a href="/">Upload More</a> | <a href="/logout">Logout</a></p>

    <!-- Search -->
    <form action="/gallery" method="get" class="search-form">
      <input type="text" name="q" placeholder="Search by name…" value="<%= typeof q !== 'undefined' ? q : '' %>" />
      <button type="submit">Search</button>
      <% if ((q || '' ).trim()) { %>
        <a href="/gallery">Clear</a>
        <% } %>
    </form>

    <!-- Sorting -->
    <div class="sort-bar">
      <label>
        Sort by
        <select id="sortKey">
          <option value="name">Name</option>
          <option value="size">Size</option>
          <option value="mtime">Date Added</option>
          <option value="type">Type</option>
        </select>
      </label>
      <label>
        Direction
        <select id="sortDir">
          <option value="asc">Ascending</option>
          <option value="desc">Descending</option>
        </select>
      </label>
      <button id="applySort" type="button">Apply</button>
      <button id="resetSort" type="button" class="ghost">Reset</button>
    </div>

    <!-- View mode (Windows Explorer-like) -->
    <div class="view-bar">
      <label>
        View
        <select id="viewMode">
          <option value="small">Small</option>
          <option value="medium" selected>Medium</option>
          <option value="large">Large</option>
          <option value="xlarge">Extra-large</option>
          <option value="huge">Huge</option>
          <option value="single">Single-File</option>
          <option value="details">List</option>
        </select>
      </label>
    </div>

    <% if (media && media.length> 0) { %>
      <!-- Multi-download controls -->
      <form id="multiDownloadForm" method="POST" action="/download-selected" class="multi-download-form"
        style="margin: 1rem 0;">
        <button type="button" id="select-all">Select All</button>
        <button type="button" id="clear-all">Clear</button>
        <button type="submit">Download Selected</button>
      </form>

      <!-- Delete all -->
      <form method="POST" action="/delete-all" style="margin: 1rem 0;"
        onsubmit="return confirm('Delete ALL your uploads? This cannot be undone.');">
        <button type="submit" class="delete-all-btn">Delete all</button>
      </form>
      <% } else { %>
        <p>No uploads yet.</p>
        <% } %>
  </div>

  <div class="gallery-wrapper">
    <div class="gallery" id="gallery" data-view="medium">
      <% media.forEach(item=> {
        const mimeType = item.mimeType || '';
        const isImage = mimeType.startsWith('image/');
        const isVideo = mimeType.startsWith('video/');

        const viewableImages = new Set([
        'image/jpeg','image/png','image/gif','image/webp','image/bmp','image/svg+xml'
        ]);
        const playableVideos = new Set(['video/mp4','video/webm','video/ogg']);

        const canEmbedImage = isImage && viewableImages.has(mimeType);
        const canEmbedVideo = isVideo && playableVideos.has(mimeType);

        const filePath = `/uploads/${username}/${item.filename}`;
        const cacheBust = (item.mtime || Date.now());
        const srcUrl = `${filePath}?v=${cacheBust}`;

        const displayName = (item.originalName || item.filename || '').toString();
        const sizeBytes = Number(item.size || item.bytes || 0);
        const mtimeMs = Number(item.mtime || item.uploadedAt || Date.now());
        const safeType = mimeType || 'unknown/unknown';
        %>
        <!-- Tile with sortable metadata -->
        <div class="gallery-item fs-box" data-name="<%- displayName.toLowerCase() %>" data-size="<%- sizeBytes %>"
          data-mtime="<%- mtimeMs %>" data-type="<%- safeType %>" title="<%- displayName %>">

          <!-- Multi-select checkbox (bound to /download-selected form) -->
          <div class="select">
            <label>
              <input
                type="checkbox"
                class="multi-select-checkbox"
                name="files"
                value="<%= item.filename %>"
                form="multiDownloadForm"
              >
              Select
            </label>
          </div>

          <div class="thumb">
            <% if (canEmbedImage) { %>
              <img class="fit-on-fullscreen" src="<%= srcUrl %>" alt="<%= displayName %>">
              <button type="button" class="fs-btn fs-btn-img" aria-label="Fullscreen image">⛶</button>
              <% } else if (canEmbedVideo) { %>
                <div class="video-wrap">
                  <video class="vid fit-on-fullscreen" controls controlslist="nodownload noplaybackrate" muted
                    playsinline preload="metadata" poster="<%= item.thumb || ''%>">
                    <source src="<%= srcUrl %>" type="<%= safeType %>">
                    Your browser does not support the video tag.
                  </video>
                  <!-- <button type="button" class="fs-btn fs-btn-video" aria-label="Fullscreen video">⛶</button> -->
                </div>
                <% } else { %>
                  <a class="download-fallback" href="<%= filePath %>" download>Download</a>
                  <% } %>
          </div>

          <!-- Label area (used in grid & list) -->
          <div class="meta">
            <div class="name" data-label="name">
              <%= displayName %>
            </div>
            <div class="sub">
              <span class="type" data-label="type">
                <%= safeType %>
              </span>
              <span class="sep">•</span>
              <span class="size" data-label="size">
                <%= (sizeBytes || 0).toLocaleString() %> B
              </span>
              <span class="sep">•</span>
              <span class="date" data-label="date">
                <%= new Date(mtimeMs).toLocaleString() %>
              </span>
              <!-- For Details view: duration shows for videos -->
              <span class="sep duration-sep" hidden>•</span>
              <span class="duration" data-label="duration" hidden></span>
            </div>
          </div>

          <form method="POST" action="/delete" class="delete-form">
            <input type="hidden" name="filename" value="<%= item.filename %>">
            <button type="submit" class="delete-btn">Delete</button>
          </form>
        </div>
        <% }) %>
    </div>
  </div>

  <script>
    (function () {
      // ------- VIDEO behavior (pause others, unmute after start) -------
      const vids = Array.from(document.querySelectorAll('video.vid'));
      vids.forEach(v => {
        v.addEventListener('play', () => {
          vids.forEach(o => { if (o !== v) o.pause(); });
        });
      });
      vids.forEach(v => {
        v.muted = true;
        v.volume = 1.0;
        const tryUnmute = () => setTimeout(() => { try { v.muted = false; } catch (_) { } }, 0);
        v.addEventListener('playing', tryUnmute, { once: true });
        v.addEventListener('timeupdate', tryUnmute, { once: true });
        v.addEventListener('click', async () => {
          if (v.paused) {
            try { v.muted = true; await v.play(); } catch (err) { console.warn('Play blocked:', err); }
          }
        });
      });

      // ------- FULLSCREEN helpers -------
      const fsEl = () =>
        document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
      const requestFS = (el) =>
        (el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen)?.call(el);
      const exitFS = () =>
        (document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen)?.call(document);

      // IMAGES: wrapper fullscreen via custom button/dblclick
      document.querySelectorAll('.fs-box').forEach(box => {
        const img = box.querySelector('img.fit-on-fullscreen');
        const imgBtn = box.querySelector('.fs-btn-img');
        if (img && imgBtn) {
          const toggle = () => (fsEl() ? exitFS() : requestFS(box));
          imgBtn.addEventListener('click', toggle);
          img.addEventListener('dblclick', toggle);

          function applyFitImg() {
            const inFs = fsEl() === box;
            if (!img) return;
            if (inFs) {
              img.style.width = '100vw';
              img.style.height = '100vh';
              img.style.objectFit = 'contain';
              img.style.background = '#000';
            } else {
              img.style.width = '';
              img.style.height = '';
              img.style.objectFit = '';
              img.style.background = '';
            }
          }
          ['fullscreenchange', 'webkitfullscreenchange', 'MSFullscreenChange']
            .forEach(evt => document.addEventListener(evt, applyFitImg));
        }
      });

      // VIDEOS: wrapper fullscreen via overlay button/dblclick
      document.querySelectorAll('.video-wrap').forEach(wrap => {
        const box = wrap.closest('.fs-box');
        const video = wrap.querySelector('video.vid');
        const btn = wrap.querySelector('.fs-btn-video');
        if (!box || !video || !btn) return;

        const toggle = () => (fsEl() ? exitFS() : requestFS(box));
        btn.addEventListener('click', toggle);
        video.addEventListener('dblclick', toggle);

        function applyFitVideo() {
          const inFs = fsEl() === box;
          if (!video) return;
          if (inFs) {
            video.style.width = '100vw';
            video.style.height = '100vh';
            video.style.objectFit = 'contain';
            video.style.background = '#000';
          } else {
            video.style.width = '';
            video.style.height = '';
            video.style.objectFit = '';
            video.style.background = '';
          }
        }
        ['fullscreenchange', 'webkitfullscreenchange', 'MSFullscreenChange']
          .forEach(evt => document.addEventListener(evt, applyFitVideo));
      });

      // ------- SORTING -------
      const gallery = document.getElementById('gallery');
      const sortKeySel = document.getElementById('sortKey');
      const sortDirSel = document.getElementById('sortDir');
      const applyBtn = document.getElementById('applySort');
      const resetBtn = document.getElementById('resetSort');

      const params = new URLSearchParams(location.search);
      if (params.has('sort')) sortKeySel.value = params.get('sort');
      if (params.has('dir')) sortDirSel.value = params.get('dir');

      function compareItems(a, b, key, dir) {
        // 0 = image, 1 = video, 2 = other
        function typeRank(el) {
          const name = (el.dataset.name || '').toLowerCase();
          if (/\.(png|jpe?g|gif|webp|bmp|heic|avif)$/.test(name)) return 0;
          if (/\.(mp4|mov|m4v|webm|mkv|avi)$/.test(name)) return 1;
          return 2;
        }

        const rankA = typeRank(a);
        const rankB = typeRank(b);
        if (rankA !== rankB) return rankA - rankB; // always ascending: images < videos < others

        // Now apply your existing key-based logic
        const da = a.dataset[key] ?? '';
        const db = b.dataset[key] ?? '';
        const isNumeric = (key === 'size' || key === 'mtime');
        let va = isNumeric ? Number(da) : String(da).toLowerCase();
        let vb = isNumeric ? Number(db) : String(db).toLowerCase();

        if (key === 'name') {
          const numA = parseInt((a.dataset.name || '').match(/\d+/)?.[0] || '0', 10);
          const numB = parseInt((b.dataset.name || '').match(/\d+/)?.[0] || '0', 10);

          if (numA !== numB) return dir === 'asc' ? numA - numB : numB - numA;

          const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
          return dir === 'asc'
            ? collator.compare(a.dataset.name, b.dataset.name)
            : collator.compare(b.dataset.name, a.dataset.name);
        }

        if (va < vb) return dir === 'asc' ? -1 : 1;
        if (va > vb) return dir === 'asc' ? 1 : -1;

        // final fallback: natural compare by name
        const na = a.dataset.name || '';
        const nb = b.dataset.name || '';
        return na.localeCompare(nb, undefined, { numeric: true, sensitivity: 'base' });
      }

      function sortGallery() {
        const key = sortKeySel.value;
        const dir = sortDirSel.value;
        const items = Array.from(gallery.children);
        items.sort((a, b) => compareItems(a, b, key, dir));
        items.forEach(el => gallery.appendChild(el));

        const p = new URLSearchParams(location.search);
        p.set('sort', key);
        p.set('dir', dir);
        history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
      }

      function resetSort() {
        sortKeySel.value = 'name';
        sortDirSel.value = 'asc';
        sortGallery();
      }

      applyBtn.addEventListener('click', sortGallery);
      resetBtn.addEventListener('click', resetSort);
      sortGallery();

      // ------- VIEW MODE (Explorer-like) -------
      const viewSel = document.getElementById('viewMode');
      if (params.has('view')) viewSel.value = params.get('view');
      function applyView() {
        const mode = viewSel.value;
        gallery.setAttribute('data-view', mode);
        const p = new URLSearchParams(location.search);
        p.set('view', mode);
        history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
      }
      viewSel.addEventListener('change', applyView);
      applyView();

      // ------- DETAILS: show duration for videos -------
      function formatDuration(sec) {
        if (!isFinite(sec)) return '';
        const s = Math.floor(sec % 60).toString().padStart(2, '0');
        const m = Math.floor((sec / 60) % 60).toString().padStart(2, '0');
        const h = Math.floor(sec / 3600);
        return h > 0 ? `${h}:${m}:${s}` : `${m}:${s}`;
      }

      // Compute durations once metadata is available
      document.querySelectorAll('.gallery-item').forEach(item => {
        const v = item.querySelector('video.vid');
        const durationEl = item.querySelector('.duration');
        const sepEl = item.querySelector('.duration-sep');
        if (!v || !durationEl || !sepEl) return;

        const setIt = () => {
          const dur = formatDuration(v.duration);
          if (dur) {
            durationEl.textContent = dur;
            durationEl.hidden = false;
            sepEl.hidden = false;
            item.dataset.duration = v.duration.toFixed(3); // optional if you later want to sort by it
          }
        };

        if (isFinite(v.duration) && v.duration > 0) {
          setIt();
        } else {
          v.addEventListener('loadedmetadata', setIt, { once: true });
        }
      });

      // ------- MULTI-DOWNLOAD: Select All / Clear -------
      const selectAllBtn = document.getElementById('select-all');
      const clearAllBtn = document.getElementById('clear-all');

      if (selectAllBtn) {
        selectAllBtn.addEventListener('click', () => {
          document.querySelectorAll('.multi-select-checkbox').forEach(cb => cb.checked = true);
        });
      }

      if (clearAllBtn) {
        clearAllBtn.addEventListener('click', () => {
          document.querySelectorAll('.multi-select-checkbox').forEach(cb => cb.checked = false);
        });
      }
    })();
  </script>
</body>

</html>
